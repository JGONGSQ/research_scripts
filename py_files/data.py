
# python package
import csv
import os
from settings import *
from geopy.geocoders import Nominatim
from geopy.distance import vincenty


def cal_distance(origin_name, destination_name):
    """
        Calculate the distance between points
    :param origin_name: such as 'TAS', 'NSW' or 'TAS'
    :param destination_name: same as origin code
    :return: distance between two point in km
    """
    # initial the package
    geolocator = Nominatim()

    # get the origin code
    origin = geolocator.geocode(origin_name)

    # get destination
    destination = geolocator.geocode(destination_name)

    # make the points
    from_origin = (origin.latitude, origin.longitude)
    to_destination = (destination.latitude, destination.longitude)
    print(from_origin, to_destination)

    distance = vincenty(from_origin, to_destination).km

    # round the distance to the closest km
    return int(distance)


def find_index_in_list(list, value):
    index = None
    for i, sub_list in enumerate(list):
        for item in sub_list:
            if item == value:
                index = i
    return index


def get_the_city_data(input_field_list, row, city_codes):
    """
    :param input_field_list: the first line of the input file
    :param row: data for each line
    :param city_codes: capital city codes
    :return: binary matrix if the person visited the capital city
    """
    city_data = [0] * city_codes.__len__()
    nites_data = [0] * city_codes.__len__()
    # need to be careful here to get the total number of stops
    number_of_stops = row.__getitem__(input_field_list.index('NUMSTOP'))

    # for each stop do the check
    for i in range(int(number_of_stops)):
        location = row.__getitem__(input_field_list.index('REGN%s' % str(i + 1)))
        # print(location)
        if location in city_codes:
            # city_data.__setitem__(city_codes.index(location), 1)

            # get the nites data, the number of days in the city
            nites = row.__getitem__(input_field_list.index('NITES%s' % str(i + 1)))
            nites_data.__setitem__(city_codes.index(location), int(nites))
            city_data.__setitem__(city_codes.index(location), int(nites))

    # print(city_data)
    return city_data, nites_data


def get_the_city_data_in_orders(input_field_list, row, city_codes):
    """
    :param input_field_list: the first line of the input file
    :param row: data for each line
    :param city_codes: capital city codes
    :return: binary matrix if the person visited the capital city
    """
    city_data = [0] * city_codes.__len__()
    nites_data = [0] * city_codes.__len__()
    # need to be careful here to get the total number of stops
    number_of_stops = row.__getitem__(input_field_list.index('NUMSTOP'))
    path = ''
    # for each stop do the check
    for i in range(int(number_of_stops)):
        location = row.__getitem__(input_field_list.index('REGN%s' % str(i + 1)))
        # print(location)
        if location in city_codes:
            # city_data.__setitem__(city_codes.index(location), 1)

            # get the nites data, the number of days in the city
            nites = row.__getitem__(input_field_list.index('NITES%s' % str(i + 1)))
            nites_data[city_codes.index(location)] += int(nites)
            city_data[city_codes.index(location)] += int(nites)
            city_name = CITY_LISTS.__getitem__(city_codes.index(location))
            path = generate_path(path, city_name)

    print(path)
    return city_data, path


def get_state_location(location):
    state_location = location[0]
    return state_location


def generate_path(path, location_name):
    if path.endswith(location_name) is False:
        if path == '':
            path += location_name
        else:
            path = path + '-' + location_name
    return path


def get_the_state_data(input_field_list, row, state_codes):
    state_data = [0] * state_codes.__len__()
    nites_data = [0] * state_codes.__len__()

    number_of_stops = row.__getitem__(input_field_list.index('NUMSTOP'))
    path = ''

    for i in range(int(number_of_stops)):
        location = row.__getitem__(input_field_list.index('REGN%s' % str(i + 1)))
        state_location = get_state_location(location)

        if state_location in state_codes:
            nites = row.__getitem__(input_field_list.index('NITES%s' % str(i + 1)))
            nites_data[state_codes.index(state_location)] += int(nites)
            state_data[state_codes.index(state_location)] += int(nites)
            state_name = STATE_LISTS.__getitem__(state_codes.index(state_location))

            path = generate_path(path, state_name)

    return state_data, path


# TODO need to calculate the distance for each alternative
def get_distance_data(input_field_list, distance_destination_list, state_list, row):
    # initial the list
    distance_data = [0] * distance_destination_list.__len__()

    number_of_stops = row.__getitem__(input_field_list.index('NUMSTOP'))

    home_location_code = row.__getitem__(input_field_list.index('HOMEREGN'))
    print("This is the home location code", home_location_code)

    for i in range(int(number_of_stops)):
        location = row.__getitem__(input_field_list.index('REGN%s' % str(i + 1)))
        print("This is the location", location)
    # print('This is the distance data', distance_data)
    # print(row)
    # print(input_field_list)
    # print('State List:', state_list)
    raise Exception

    return distance_data


def get_the_utility_variable_data(input_field_list, row, variable, variable_codes):
    """
    :param input_field_list:
    :param row:
    :param variable:
    :param variable_codes:
    :return:
    """
    variable_data = [0] * variable_codes.__len__()
    value = row.__getitem__(input_field_list.index(variable))
    print("### This is the value in the line:", value)
    if value:
        variable_data.__setitem__(find_index_in_list(list=variable_codes, value=value), 1)

    return variable_data


def read_file(filename, field_list, number_of_data=1000000):
    """
        Read the source file
    :param filename: The name of the input file with its path
    :param field_list: The field would be look up
    :param number_of_data: the total number of data needed for computation, if not given, would be 1,000,000 as default
    :return: results list
    """
    # initial the list
    results = list()
    field_index = list()

    # open the file need to be read
    with open(filename, 'rb') as csvfile:

        # initial the reader
        file_reader = csv.reader(csvfile, delimiter=',')

        # looping each row
        for i, row in enumerate(file_reader):
            if i == 0:

                # first line of the file are fieldnames
                for item in field_list:
                    field_index.append(row.index(item))

                # append it to the results
                results.append(field_list)

            elif i > number_of_data:
                break

            else:
                # get the row trim with its index number
                row_trim = map(row.__getitem__, field_index)

                # append row_trim
                results.append(row_trim)

    # return as list
    return results


def read_file_by_city(filename, compulsory_fields, city_lists, city_codes, utility_parameters, number_of_data=1000000):
    """
    :param filename: the input file name as path
    :param compulsory_fields: example in the settings file, should be list of fileds
    :param city_lists: list of city names
    :param city_codes: list of city codes
    :param utility_parameters: list of utility parameters for the model
    :param number_of_data: maximum number going to read, if not given, would be 1 million.
    :return: results as list
    """
    print utility_parameters
    results = list()
    output_field_list = compulsory_fields + city_lists + utility_parameters
    input_field_list = None
    j = 1
    with open(filename, 'rb') as csvfile:
        file_reader = csv.reader(csvfile, delimiter=',')

        for i, row in enumerate(file_reader):
            if i == 0:
                input_field_list = row
                # print(output_field_list)
                results.append(output_field_list)

            elif i > number_of_data:
                break

            else:
                # getting the value of the utility parameters
                utility_data = map(row.__getitem__, map(input_field_list.index, utility_parameters))

                # To check the utility data is empty or not
                if ' ' not in utility_data:

                    city_data, nites_data = get_the_city_data(input_field_list, row, city_codes)

                    # to see uf visited the major city
                    if all(value is 0 for value in city_data) is False:

                        # initial the row for each line with all zeros
                        output_row = [0] * output_field_list.__len__()

                        # getting the value of the compulsory part
                        compulosry_data = map(row.__getitem__, map(input_field_list.index, compulsory_fields))
                        compulosry_data[0] = j

                        # setting the values according to the index number
                        data_set = compulosry_data + city_data + utility_data
                        map(output_row.__setitem__, map(output_field_list.index, output_field_list), data_set)

                        print(output_row)

                        results.append(output_row)
                        j += 1

    return results


def write_file(filename, data):
    """
        Write the results list to generate a new data file
    :param filename: the name of the output file with its path
    :param data: its a two-dimensional array
    :return: True if success
    """

    # open the file need to be write
    with open(filename, 'w') as csvfile:
        # initial the writer
        writer = csv.writer(csvfile, delimiter=',')

        # write each row
        for row in data:
            writer.writerow(row)

    return True


def convert_list_to_str(input_list):
    output_string = ''

    for i, item in enumerate(input_list):
        output_string = output_string + item
        if i != len(input_list) - 1:
            output_string += ','

    return output_string


def convert_tuple_to_list(tuple_object):
    list_object = list()

    for item in tuple_object:
        list_object.append(item)

    return list_object


def case_config_excluding_variables(case_config):
    list_of_variables = ALL_VARIABLES

    # if case_config == 1:
    #     list_of_variables = list(set(ALL_VARIABLES).difference(set(EXECLUDE_VARIABLE_1)))
    #
    # if case_config == 4:
    #     list_of_variables = list(set(ALL_VARIABLES).difference(set(EXECLUDE_VARIABLE_4)))
    #
    # if case_config == 7:
    #     list_of_variables = list(set(ALL_VARIABLES).difference(set(EXECLUDE_VARIABLE_7)))

    return list_of_variables


def filter_files(dirpath):
    files = os.listdir(dirpath)

    for file in files:
        if os.path.isdir(dirpath + '/' + file):
            pass
        else:
            if is_file_converge(dirpath + '/' + file):
                os.rename(dirpath + '/' + file, dirpath + '/converge/' + file)
            else:
                os.rename(dirpath + '/' + file, dirpath + '/notconverge/' + file)
    return


def get_utility_variables(alternatives):
    utility_variable = list()

    # in each alternative may have the different variable
    for alternative in alternatives:

        for item in alternative:
            if item not in utility_variable:
                utility_variable.append(item)

    return utility_variable


def is_file_converge(filepath):
    try:
        with open(filepath, 'r') as fp:
            if 'Inf' in fp.read():
                return False
            else:
                return True
    except Exception:
        return False


def get_utility_parameters_list(utility_parameters):
    utility_parameters_list = list()

    for variable in utility_parameters:

        variable_list = get_the_vairable_list(variable)
        if variable_list:
            utility_parameters_list += variable_list
        else:
            utility_parameters_list.append(variable)

    return utility_parameters_list


def get_utility_parameters_value(input_field_list, utility_parameters, row):
    value_list = list()
    # print utility_parameters
    for variable in utility_parameters:
        variable_codes = get_the_variable_codes(variable)
        print variable
        if variable_codes:
            variable_data = get_the_utility_variable_data(
                input_field_list=input_field_list,
                row=row,
                variable=variable,
                variable_codes=variable_codes
            )
            value_list += variable_data
        else:
            # print input_field_list.index(variable)
            value_list.append(row.__getitem__(int(input_field_list.index(variable))))

    return value_list


def get_the_variable_codes(variable):
    variable_codes = None

    if variable == 'ORIGIN':
        variable_codes = ORIGIN_CODE

    elif variable == 'PARENT':
        variable_codes = PARENT_CODE

    elif variable == 'YOUNGEST':
        variable_codes = YOUNGEST_CODE

    elif variable == "GENDER":
        variable_codes = GENDER_CODE

    elif variable == 'MARITAL':
        variable_codes = MARITAL_CODE

    elif variable == 'EMPLOYMENT':
        variable_codes = EMPLOYMENT_CODE

    elif variable == 'HOUSINC':
        variable_codes = HOUSINC_CODE

    elif variable == 'LIFECYCLE':
        variable_codes = LIFECYCLE_CODE

    elif variable == 'AGEGROUP':
        variable_codes = AGEGROUP_CODE

    return variable_codes


def get_the_vairable_list(variable):
    variable_list = None
    if variable == 'ORIGIN':
        variable_list = ORIGIN_LIST

    elif variable == 'PARENT':
        variable_list = PARENT_LIST

    elif variable == 'YOUNGEST':
        variable_list = YOUNGEST_LIST

    elif variable == "GENDER":
        variable_list = GENDER_LIST

    elif variable == 'MARITAL':
        variable_list = MARITAL_LIST

    elif variable == 'EMPLOYMENT':
        variable_list = EMPLOYMENT_LIST

    elif variable == 'HOUSINC':
        variable_list = HOUSINC_LIST

    elif variable == 'LIFECYCLE':
        variable_list = LIFECYCLE_LIST

    elif variable == 'AGEGROUP':
        variable_list = AGEGROUP_LIST

    return variable_list


def count_zero(data):
    count = 0
    for item in data:
        if item == 0:
            count += 1
    return count





def trim_data(input_file, output_file, compulsory_fields, city_lists, city_codes, utility_parameters, number_of_data=40000):
    """
    :param input_file: the path of the input file
    :param output_file: the path of the output file
    :param compulsory_fields: compulsory fields for the R package
    :param city_lists: list of city names
    :param city_codes: list tof city codes
    :param utility_parameters: list of utility parameters for the model
    :param number_of_data: maximum number of data going to be read, if not givem the default value is 2000
    :return: Boolean value
    """
    print utility_parameters
    # initials
    data = list()
    input_field_list = None
    index_number = 1

    utility_parameters_list = get_utility_parameters_list(utility_parameters)
    output_fields_list = compulsory_fields + city_lists + utility_parameters_list

    # append headings here
    data.append(output_fields_list)

    with open(input_file, 'rU') as input_csv:
        file_reader = csv.reader(input_csv, delimiter=',')

        # process the data line by line
        for i, row in enumerate(file_reader):
            if i == 0:
                input_field_list = row

            elif i > number_of_data:
                break
            else:
                # getting the value of the utility parameters
                utility_data = map(row.__getitem__, map(input_field_list.index, utility_parameters))

                if ' ' not in utility_data:
                    city_data, nites_data = get_the_city_data(input_field_list, row, city_codes)

                    # if city_data.__len__() - 1 == count_zero(city_data):
                    if city_data.__len__() - 2 >= count_zero(city_data):
                    # if all(value is 0 for value in city_data) is False:


                        # initial the row for each line with all zeros
                        output_row = [0] * output_fields_list.__len__()

                        # getting the value of the compulsory part
                        compulsory_data = map(row.__getitem__, map(input_field_list.index, compulsory_fields))
                        compulsory_data[0] = index_number

                        # getting the utility parameters data according to the utility parameters
                        utility_variable_data = get_utility_parameters_value(input_field_list, utility_parameters, row)

                        # setting the values according to the index number
                        data_set = compulsory_data + city_data + utility_variable_data
                        map(output_row.__setitem__, map(output_fields_list.index, output_fields_list), data_set)

                        print(output_row)
                        data.append(output_row)
                        index_number += 1

    # write the data to the output file
    is_successful = write_file(filename=output_file, data=data)
    return is_successful


def read_state_combinations(input_file, output_file, compulsory_fields, state_lists, state_codes, utility_parameters, distance_destination_list,number_of_data=40000):

    print utility_parameters
    # initials
    input_field_list = None
    index_number = 1
    data = list()

    # make the title
    utility_parameters_list = get_utility_parameters_list(utility_parameters)
    output_fields_list = compulsory_fields + state_lists + utility_parameters_list + distance_destination_list

    # append the title
    data.append(output_fields_list)

    with open(input_file, 'rU') as input_csv:
        file_reader = csv.reader(input_csv, delimiter=',')

        for i, row in enumerate(file_reader):
            if i == 0:
                input_field_list = row
            elif i > number_of_data:
                break
            else:
                # getting the value of the utility parameters
                utility_data = map(row.__getitem__, map(input_field_list.index, utility_parameters))
                if ' ' not in utility_data:

                    state_data, order_data = get_the_state_data(input_field_list, row, state_codes)

                    # if state_data.__len__() - 1 == count_zero(state_data):
                    if state_data.__len__() - 2 >= count_zero(state_data):
                    # if all(value is 0 for value in state_data) is False:
                        output_row = [0] * output_fields_list.__len__()
                        compulsory_data = map(row.__getitem__, map(input_field_list.index, compulsory_fields))
                        compulsory_data[0] = index_number
                        compulsory_data[3] = order_data

                        # getting the utility parameters data according to the utility parameters
                        utility_variable_data = get_utility_parameters_value(input_field_list, utility_parameters, row)
                        distance_data = get_distance_data(input_field_list, distance_destination_list, state_lists, row)

                        data_set = compulsory_data + state_data + utility_variable_data + distance_data
                        map(output_row.__setitem__, map(output_fields_list.index, output_fields_list), data_set)

                        print(output_row)
                        data.append(output_row)
                        index_number += 1

    is_successful = write_file(filename=output_file, data=data)
    return is_successful
